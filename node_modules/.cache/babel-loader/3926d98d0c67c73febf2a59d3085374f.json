{"ast":null,"code":"import { __assign } from \"tslib\";\nimport { getCurrentHub } from '@sentry/core';\nimport { fill, logger, parseSemver } from '@sentry/utils';\nimport { cleanSpanDescription, extractUrl, isSentryRequest, normalizeRequestArgs } from './utils/http';\nvar NODE_VERSION = parseSemver(process.versions.node);\n/** http module integration */\n\nvar Http =\n/** @class */\nfunction () {\n  /**\n   * @inheritDoc\n   */\n  function Http(options) {\n    if (options === void 0) {\n      options = {};\n    }\n    /**\n     * @inheritDoc\n     */\n\n\n    this.name = Http.id;\n    this._breadcrumbs = typeof options.breadcrumbs === 'undefined' ? true : options.breadcrumbs;\n    this._tracing = typeof options.tracing === 'undefined' ? false : options.tracing;\n  }\n  /**\n   * @inheritDoc\n   */\n\n\n  Http.prototype.setupOnce = function () {\n    // No need to instrument if we don't want to track anything\n    if (!this._breadcrumbs && !this._tracing) {\n      return;\n    }\n\n    var wrappedHandlerMaker = _createWrappedRequestMethodFactory(this._breadcrumbs, this._tracing);\n\n    var httpModule = require('http');\n\n    fill(httpModule, 'get', wrappedHandlerMaker);\n    fill(httpModule, 'request', wrappedHandlerMaker); // NOTE: Prior to Node 9, `https` used internals of `http` module, thus we don't patch it.\n    // If we do, we'd get double breadcrumbs and double spans for `https` calls.\n    // It has been changed in Node 9, so for all versions equal and above, we patch `https` separately.\n\n    if (NODE_VERSION.major && NODE_VERSION.major > 8) {\n      var httpsModule = require('https');\n\n      fill(httpsModule, 'get', wrappedHandlerMaker);\n      fill(httpsModule, 'request', wrappedHandlerMaker);\n    }\n  };\n  /**\n   * @inheritDoc\n   */\n\n\n  Http.id = 'Http';\n  return Http;\n}();\n\nexport { Http };\n/**\n * Function which creates a function which creates wrapped versions of internal `request` and `get` calls within `http`\n * and `https` modules. (NB: Not a typo - this is a creator^2!)\n *\n * @param breadcrumbsEnabled Whether or not to record outgoing requests as breadcrumbs\n * @param tracingEnabled Whether or not to record outgoing requests as tracing spans\n *\n * @returns A function which accepts the exiting handler and returns a wrapped handler\n */\n\nfunction _createWrappedRequestMethodFactory(breadcrumbsEnabled, tracingEnabled) {\n  return function wrappedRequestMethodFactory(originalRequestMethod) {\n    return function wrappedMethod() {\n      var args = [];\n\n      for (var _i = 0; _i < arguments.length; _i++) {\n        args[_i] = arguments[_i];\n      } // eslint-disable-next-line @typescript-eslint/no-this-alias\n\n\n      var httpModule = this;\n      var requestArgs = normalizeRequestArgs(args);\n      var requestOptions = requestArgs[0];\n      var requestUrl = extractUrl(requestOptions); // we don't want to record requests to Sentry as either breadcrumbs or spans, so just use the original method\n\n      if (isSentryRequest(requestUrl)) {\n        return originalRequestMethod.apply(httpModule, requestArgs);\n      }\n\n      var span;\n      var parentSpan;\n      var scope = getCurrentHub().getScope();\n\n      if (scope && tracingEnabled) {\n        parentSpan = scope.getSpan();\n\n        if (parentSpan) {\n          span = parentSpan.startChild({\n            description: (requestOptions.method || 'GET') + \" \" + requestUrl,\n            op: 'request'\n          });\n          var sentryTraceHeader = span.toTraceparent();\n          logger.log(\"[Tracing] Adding sentry-trace header to outgoing request: \" + sentryTraceHeader);\n          requestOptions.headers = __assign(__assign({}, requestOptions.headers), {\n            'sentry-trace': sentryTraceHeader\n          });\n        }\n      } // eslint-disable-next-line @typescript-eslint/no-unsafe-member-access\n\n\n      return originalRequestMethod.apply(httpModule, requestArgs).once('response', function (res) {\n        // eslint-disable-next-line @typescript-eslint/no-this-alias\n        var req = this;\n\n        if (breadcrumbsEnabled) {\n          addRequestBreadcrumb('response', requestUrl, req, res);\n        }\n\n        if (tracingEnabled && span) {\n          if (res.statusCode) {\n            span.setHttpStatus(res.statusCode);\n          }\n\n          span.description = cleanSpanDescription(span.description, requestOptions, req);\n          span.finish();\n        }\n      }).once('error', function () {\n        // eslint-disable-next-line @typescript-eslint/no-this-alias\n        var req = this;\n\n        if (breadcrumbsEnabled) {\n          addRequestBreadcrumb('error', requestUrl, req);\n        }\n\n        if (tracingEnabled && span) {\n          span.setHttpStatus(500);\n          span.description = cleanSpanDescription(span.description, requestOptions, req);\n          span.finish();\n        }\n      });\n    };\n  };\n}\n/**\n * Captures Breadcrumb based on provided request/response pair\n */\n\n\nfunction addRequestBreadcrumb(event, url, req, res) {\n  if (!getCurrentHub().getIntegration(Http)) {\n    return;\n  }\n\n  getCurrentHub().addBreadcrumb({\n    category: 'http',\n    data: {\n      method: req.method,\n      status_code: res && res.statusCode,\n      url: url\n    },\n    type: 'http'\n  }, {\n    event: event,\n    request: req,\n    response: res\n  });\n}","map":{"version":3,"sources":["../../src/integrations/http.ts"],"names":[],"mappings":"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","sourcesContent":["import { getCurrentHub } from '@sentry/core';\nimport { Integration, Span } from '@sentry/types';\nimport { fill, logger, parseSemver } from '@sentry/utils';\nimport * as http from 'http';\nimport * as https from 'https';\n\nimport {\n  cleanSpanDescription,\n  extractUrl,\n  isSentryRequest,\n  normalizeRequestArgs,\n  RequestMethod,\n  RequestMethodArgs,\n} from './utils/http';\n\nconst NODE_VERSION = parseSemver(process.versions.node);\n\n/** http module integration */\nexport class Http implements Integration {\n  /**\n   * @inheritDoc\n   */\n  public static id: string = 'Http';\n\n  /**\n   * @inheritDoc\n   */\n  public name: string = Http.id;\n\n  /**\n   * @inheritDoc\n   */\n  private readonly _breadcrumbs: boolean;\n\n  /**\n   * @inheritDoc\n   */\n  private readonly _tracing: boolean;\n\n  /**\n   * @inheritDoc\n   */\n  public constructor(options: { breadcrumbs?: boolean; tracing?: boolean } = {}) {\n    this._breadcrumbs = typeof options.breadcrumbs === 'undefined' ? true : options.breadcrumbs;\n    this._tracing = typeof options.tracing === 'undefined' ? false : options.tracing;\n  }\n\n  /**\n   * @inheritDoc\n   */\n  public setupOnce(): void {\n    // No need to instrument if we don't want to track anything\n    if (!this._breadcrumbs && !this._tracing) {\n      return;\n    }\n\n    const wrappedHandlerMaker = _createWrappedRequestMethodFactory(this._breadcrumbs, this._tracing);\n\n    const httpModule = require('http');\n    fill(httpModule, 'get', wrappedHandlerMaker);\n    fill(httpModule, 'request', wrappedHandlerMaker);\n\n    // NOTE: Prior to Node 9, `https` used internals of `http` module, thus we don't patch it.\n    // If we do, we'd get double breadcrumbs and double spans for `https` calls.\n    // It has been changed in Node 9, so for all versions equal and above, we patch `https` separately.\n    if (NODE_VERSION.major && NODE_VERSION.major > 8) {\n      const httpsModule = require('https');\n      fill(httpsModule, 'get', wrappedHandlerMaker);\n      fill(httpsModule, 'request', wrappedHandlerMaker);\n    }\n  }\n}\n\n// for ease of reading below\ntype OriginalRequestMethod = RequestMethod;\ntype WrappedRequestMethod = RequestMethod;\ntype WrappedRequestMethodFactory = (original: OriginalRequestMethod) => WrappedRequestMethod;\n\n/**\n * Function which creates a function which creates wrapped versions of internal `request` and `get` calls within `http`\n * and `https` modules. (NB: Not a typo - this is a creator^2!)\n *\n * @param breadcrumbsEnabled Whether or not to record outgoing requests as breadcrumbs\n * @param tracingEnabled Whether or not to record outgoing requests as tracing spans\n *\n * @returns A function which accepts the exiting handler and returns a wrapped handler\n */\nfunction _createWrappedRequestMethodFactory(\n  breadcrumbsEnabled: boolean,\n  tracingEnabled: boolean,\n): WrappedRequestMethodFactory {\n  return function wrappedRequestMethodFactory(originalRequestMethod: OriginalRequestMethod): WrappedRequestMethod {\n    return function wrappedMethod(this: typeof http | typeof https, ...args: RequestMethodArgs): http.ClientRequest {\n      // eslint-disable-next-line @typescript-eslint/no-this-alias\n      const httpModule = this;\n\n      const requestArgs = normalizeRequestArgs(args);\n      const requestOptions = requestArgs[0];\n      const requestUrl = extractUrl(requestOptions);\n\n      // we don't want to record requests to Sentry as either breadcrumbs or spans, so just use the original method\n      if (isSentryRequest(requestUrl)) {\n        return originalRequestMethod.apply(httpModule, requestArgs);\n      }\n\n      let span: Span | undefined;\n      let parentSpan: Span | undefined;\n\n      const scope = getCurrentHub().getScope();\n      if (scope && tracingEnabled) {\n        parentSpan = scope.getSpan();\n        if (parentSpan) {\n          span = parentSpan.startChild({\n            description: `${requestOptions.method || 'GET'} ${requestUrl}`,\n            op: 'request',\n          });\n\n          const sentryTraceHeader = span.toTraceparent();\n          logger.log(`[Tracing] Adding sentry-trace header to outgoing request: ${sentryTraceHeader}`);\n          requestOptions.headers = { ...requestOptions.headers, 'sentry-trace': sentryTraceHeader };\n        }\n      }\n\n      // eslint-disable-next-line @typescript-eslint/no-unsafe-member-access\n      return originalRequestMethod\n        .apply(httpModule, requestArgs)\n        .once('response', function(this: http.ClientRequest, res: http.IncomingMessage): void {\n          // eslint-disable-next-line @typescript-eslint/no-this-alias\n          const req = this;\n          if (breadcrumbsEnabled) {\n            addRequestBreadcrumb('response', requestUrl, req, res);\n          }\n          if (tracingEnabled && span) {\n            if (res.statusCode) {\n              span.setHttpStatus(res.statusCode);\n            }\n            span.description = cleanSpanDescription(span.description, requestOptions, req);\n            span.finish();\n          }\n        })\n        .once('error', function(this: http.ClientRequest): void {\n          // eslint-disable-next-line @typescript-eslint/no-this-alias\n          const req = this;\n\n          if (breadcrumbsEnabled) {\n            addRequestBreadcrumb('error', requestUrl, req);\n          }\n          if (tracingEnabled && span) {\n            span.setHttpStatus(500);\n            span.description = cleanSpanDescription(span.description, requestOptions, req);\n            span.finish();\n          }\n        });\n    };\n  };\n}\n\n/**\n * Captures Breadcrumb based on provided request/response pair\n */\nfunction addRequestBreadcrumb(event: string, url: string, req: http.ClientRequest, res?: http.IncomingMessage): void {\n  if (!getCurrentHub().getIntegration(Http)) {\n    return;\n  }\n\n  getCurrentHub().addBreadcrumb(\n    {\n      category: 'http',\n      data: {\n        method: req.method,\n        status_code: res && res.statusCode,\n        url,\n      },\n      type: 'http',\n    },\n    {\n      event,\n      request: req,\n      response: res,\n    },\n  );\n}\n"],"sourceRoot":""},"metadata":{},"sourceType":"module"}